name: Vibely Frontend Pipeline

on:
  push:
    branches:
      - staging

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install Angular CLI
        run: npm install -g @angular/cli

      - name: Install dependencies
        run: npm ci

      - name: Build production
        run: npm run build -- --configuration production

  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ vars.SERVER_KEY }}
        run: |
          mkdir -p ~/key
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/key/mykey.pem
          chmod 600 ~/key/mykey.pem

      - name: Debug SSH Key
        run: |
          echo "Checking if key file exists..."
          ls -la ~/key/mykey.pem

          echo "Checking file permissions..."
          stat ~/key/mykey.pem

          echo "Checking file size..."
          wc -c ~/key/mykey.pem

          echo "Checking key format (first/last lines)..."
          head -n 1 ~/key/mykey.pem
          tail -n 1 ~/key/mykey.pem

          echo "Validating key..."
          ssh-keygen -l -f ~/key/mykey.pem || echo "Key validation failed!"

          echo "Checking for whitespace issues..."
          file ~/key/mykey.pem

      - name: Run deployment over Cloudflare SSH
        run: |
          ssh -i ~/key/mykey.pem -o StrictHostKeyChecking=no -o ProxyCommand="cloudflared access ssh --hostname ssh.vib3ly.shop" nitesh@ssh.vib3ly.shop << 'EOF'

            echo "Current directory check:"
            pwd

            echo "Changing directory..."
            cd Desktop/vibely/frontend/Vibely-Frontend

            echo "Checking pwd:"
            pwd

            echo "Checking out staging branch..."
            git checkout staging
            git pull origin staging

            echo "Installing dependencies..."
            npm ci

            echo "Building project..."
            npm run build -- --configuration production

            echo "Removing Old dist"
            rm -r  ~/../../var/www/vib3ly-app/dist/

            echo "Copy dist to var/www/vib3ly-auth/"
            mv dist/ ~/../../var/www/vib3ly-app/dist/
          EOF
